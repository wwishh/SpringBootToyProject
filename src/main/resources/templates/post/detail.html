<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>게시글 상세</title>
  <link rel="stylesheet" th:href="@{/css/main.css}">

  <!-- CSRF 토큰 메타태그 -->
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<div th:replace="~{fragments/header :: header-bar}"></div>

<main class="container">
  <h1 th:text="${post.title}">게시글 제목</h1>
  <p>작성자: <span th:text="${post.author}">작성자명</span></p>
  <p>작성일: <span th:text="${formattedDate}">2025-05-20</span></p>
  <hr>
  <p th:text="${post.content}">게시글 내용</p>

  <hr>

  <!-- 댓글 섹션 -->
  <section id="comment-section">
    <h3>댓글</h3>

    <!-- 게시글 ID 전달용 -->
    <input type="hidden" id="post-id" th:value="${post.id}" />

    <textarea id="comment-content" rows="3" placeholder="댓글을 입력하세요"></textarea><br>
    <button id="add-comment-btn" type="button" class="btn">댓글 등록</button>

    <ul id="comment-list">
      <li th:each="comment : ${comments}" th:id="'comment-' + ${comment.id}">
        <strong th:text="${comment.username}">작성자</strong>:
        <span th:text="${comment.content}">댓글 내용</span>
        <small th:text="${comment.createdAt}">2025-05-20 12:00</small>

        <span th:if="${#authentication.name == comment.username or #authorization.expression('hasRole(''ADMIN'')')}">
          <button class="edit-comment-btn btn" type="button" th:data-id="${comment.id}">수정</button>
          <button class="delete-comment-btn btn" type="button" th:data-id="${comment.id}">삭제</button>
        </span>
      </li>
    </ul>
  </section>
</main>

<script>
  $(document).ready(function () {
      const postId = $('#post-id').val();

      // CSRF 토큰 값 읽기
      const token = $('meta[name="_csrf"]').attr('content');
      const header = $('meta[name="_csrf_header"]').attr('content');

      $.ajaxSetup({
          beforeSend: function(xhr) {
              xhr.setRequestHeader(header, token);
          }
      });

      $('#add-comment-btn').click(function () {
          const content = $('#comment-content').val().trim();

          if (!content) {
              alert("댓글 내용을 입력해주세요.");
              return;
          }

          $.ajax({
              url: '/comments',
              type: 'POST',
              data: {
                  postId: postId,
                  content: content
              },
              success: function (newComment) {
                  $('#comment-content').val('');

                  $('#comment-list').append(
                    `<li id="comment-${newComment.id}">
                        <strong>${newComment.username}</strong>:
                        <span>${newComment.content}</span>
                        <small>${newComment.createdAt}</small>
                        <span>
                            <button class="edit-comment-btn btn" type="button" data-id="${newComment.id}">수정</button>
                            <button class="delete-comment-btn btn" type="button" data-id="${newComment.id}">삭제</button>
                        </span>
                    </li>`
                  );
              },
              error: function () {
                  alert("댓글 등록 중 오류가 발생했습니다.");
              }
          });
      });

      // TODO: 댓글 수정/삭제 기능 구현
  });
</script>

</body>
</html>
